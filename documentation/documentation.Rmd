---
author:
  - name: Anna Michalek
    affiliation: European Central Bank
    email: \email{anna.michalek@ecb.int}
  - name: Alain Quartier-la-Tente
    affiliation: "Insee"
    email: \email{alain.quartier@gmail.com}
title:
  formatted: "\\pkg{RJDemetra}: A R Interface To JDemetra+ Seasonal Adjustment Software"
  # If you use tex in the formatted title, also supply version without
  plain:     "\\pkg{RJDemetra}: A R Interface To JDemetra+ Seasonal Adjustment Software"
  # For running headers, if needed
  short:     "\\pkg{RJDemetra}: A R Interface To JDemetra+ Seasonal Adjustment Software"
abstract: >
  The abstract of the article.
keywords:
  # at least one keyword must be supplied
  formatted: ["\\proglang{R}", seasonal adjustment, calendar effects, ARIMA, time series]
  plain:     [R, seasonal adjustment, calendar effects, ARIMA, time series]
preamble: >
  \usepackage{amsmath}
  \usepackage{booktabs}
  \usepackage{longtable}
  \usepackage{array}
  \usepackage{multirow}
  \usepackage{wrapfig}
  \usepackage{float}
  \usepackage{pdflscape}
  \usepackage{tabu}
  \usepackage{threeparttable}
  \usepackage{threeparttablex}
  \usepackage[normalem]{ulem}
  \usepackage{makecell}

output: rticles::jss_article
bibliography: biblio.bib
biblio-style: jss
link-citations: true
---
```{r, include=FALSE}
knitr::opts_chunk$set(
  fig.path = "img/img-"
)
library(knitr)
library(kableExtra)
library(RJDemetra)
options(enable_print_style = FALSE)
# A travailler
# caption_below <- function(table){
#   lines <- strsplit(table,"\\n")[[1]]
#   caption_line <- grep("\\caption{",lines,fixed = TRUE)
#   if(length(caption_line) >0){
#     caption_line_text <- lines[caption_line]
#     caption_line_text <- sub("\\\\\\\\$","", caption_line_text)
#     lines <- gsub("\\end{longtable}",sprintf("%s\\end{longtable}", caption_line_text),lines,fixed = TRUE)
#   }
#   lines <- paste0(lines,collapse = "\\n")
#   lines
# }
```

# Introduction

Since the 20th century, more and more infra-annual statistics are produced, especially by national institutes, to analyse the short-term evolution of an economy. It is for example the case of the gross domestic product (GDP), unemployment rate, household consumption of goods and industrial production indices. However, most of those time series are affected by seasonal and trading days effects. A seasonal effect is an effect that occur in the same calendar month with similar magnitude and direction from year to year. For instance, automobile production is usually lower during summer, due to holidays, and chocolate sales are usually higher in December, due to Christmas. Trading days effect is the fact that a time series can be affected by each calendar month’s weekday composition. For example retail sales are usually higher on Saturday, thus they are likely to be higher in months with a surplus of weekend days.

Therefore, seasonal and trading days effects can make it difficult to analyse the infra-annual movements of a time series or to make spatial comparison. That’s why time series are often seasonally and trading days adjusted and seasonal adjustment is the process of removing the effects of seasonal and trading day fluctuations.

The most popular seasonal adjustment methods are TRAMO-SEATS+[^1] [@gomez1996programs; @caporello2004program], a parametric method based on ARIMA models, and X-13-ARIMA-SEATS[^2] [@findleyx12; @ladiray1999x11en], a non-parametric method based on moving average. Both methods are recommended by Eurostat and the European Central Bank (ECB) to seasonnaly adjust economic indicators. These methods proceed in two steps summarized in figure \ref{fig:2_step_proc}.

[^1]: The program TRAMO-SEATS+ was developed by Gianluca Caporello and Agustin Maravall --- with programming support from Domingo Perez and Roberto Lopez --- at the Bank of Spain. It is based on the program TRAMO-SEATS, previously developed by Victor Gomez and Agustin Maravall.

[^2]: The program X-13ARIMA-SEATS is a produced, distributed, and maintained by the US-Census Bureau.

\begin{figure}[htb]
\centering
\includegraphics[scale=0.8]{img/sa_2_steps.PNG} 
\caption{X-13-ARIMA-SEATS and TRAMO-SEATS+ 2-step process: pre-adjustment and decomposition.}
\label{fig:2_step_proc}
\end{figure}

The **first step** of seasonal adjustment consists of pre-adjusting the time series by removing from it the deterministic effects and estimating missing observations. Among deterministic effects, we distinguish outliers, calendar and regression effects. In this step, also forecasts and backcasts of the pre-adjusted series are estimated which allows applying linear filters at both ends of the series in the second step of the seasonal adjustment. The pre-adjustment, linearization, of the input series is achieved with a **RegARIMA** model (model with ARIMA errors) as specified below. 

$$z_t=y_t\beta+x_t$$
where

* $z_t$ - is the original series;
* $\beta = (\beta_1,\dots,\beta_n)$ - a vector of regression coefficients;
* $y_t = (y_{1t},\dots,y_{nt})$ - $n$ regression variables (outliers, calendar effects, user-defined variables);
* $x_t$ - a disturbance that follows the general ARIMA process:
* $\phi(B)\delta(B)x_t=\theta(B)a_t$; $\phi(B), \delta(B)$ and $\theta(B)$ are the finite polynomials in $B$; $a_t$ is a white-noise variable with zero mean and a constant variance.

 The polynomial $\phi(B)$ is a stationary autoregressive (AR) polynomial in $B$, which is a product of the stationary regular AR polynomial in $B$ and the stationary seasonal polynomial in $B^s$:

$$\phi(B)=\phi_p(B)\Phi_{bp}(B^s)=(1+\phi_1B+\dots+\phi_pB^p)(1+\Phi_1B^s+\dots+\Phi_{bp}B^{bps}$$

 where:

* $p$ - number of regular AR terms (in the package and in JDemetra+ $p \le 3$);
* $bp$ - number of seasonal AR terms (in the package and in JDemetra+ $bp \le 1$);
* $s$ - number of observations per year (frequency of the time series).
 
 The polynomial $\theta(B)$ is an invertible moving average (MA) polynomial in $B$, which is a product of the invertible regular MA polynomial in $B$ and the invertible seasonal MA polynomial in $B^s$:

 $$\theta(B)=\theta_q(B)\Theta_{bq}(B^s)=(1+\theta_1B+\dots+\theta_qB^q)(1+\Theta_1B^s+\dots+\Theta_{bq}B^{bqs})$$

 where:

* $q$ - number of regular MA terms (in the package and in JDemetra+ $q \le 3$);
* $bq$ - number of seasonal MA terms (in the package and in JDemetra+ $bq \le 1$);


The polynomial $\delta(B)$ is the non-stationary AR polynomial in $B$ (unit roots):

$$\delta(B)=(1-B)^d(1-B^s)^{d_s}$$

 where:

* $d$ - regular differencing order (in the package and in JDemetra+ $d \le 1$);
* $d_s$ - seasonal differencing order (in the package and in JDemetra+ $d_s \le 1$);

An automatic modelling is also implemented in both methods to: determine the decomposition of the series, detect outliers and calendar effects and to adjust residuals to an ARIMA models. A detailed description can be found in \cite{gomez1998automatic}.


In the **second part** of seasonal adjustment, called the **decomposition**, the pre-adjusted series ($y$) is decomposed into the following components: trend-cycle ($t$), seasonal component ($s$) and irregular component ($i$). The decomposition can be: 

* additive ($y = t + s + i$)  
* multiplicative ($y = t * s * i$)  
* log-additive ($\log(y) = \log(t) + \log(s) + \log(i)$) or  
* pseudo-additive ($y = t * (s + i - 1)$) 

The last two decompositions are available only under X13 (? à discuter).

The method of decomposing the pre-adjusted series differs between TRAMO-SEATS+ and X-12ARIMA/X-13ARIMA. In TRAMO-SEATS+, SEATS (Signal Extraction in ARIMA Time Series) decomposes the observed series with a ARIMA-model based method [@gomez1996programs; @caporello2004program]. Whereas in X-12ARIMA/X-13ARIMA, the X-11 algorithm decomposes the time series by means of linear filters [@findleyx12; @ladiray1999x11en].

As a result of seasonal adjustment, the final seasonally adjusted series shall be free of seasonal and calendar-related movements.

# JDemetra+ and RJDemetra

JDemetra+ is a new tool for seasonal adjustment (SA) developed by the National Bank of Belgium (NBB) in cooperation with the Deutsche Bundesbank and Eurostat in accordance with the Guidelines of the European Statistical System (ESS) [@eurostat2015guidelines]. It implements the concepts and algorithms used in the two leading SA methods: TRAMO-SEATS+ and X-12ARIMA/X-13ARIMA-SEATS. Those methods have been re-engineered using an object-oriented approach that enables easier handling, extensions and modifications.

JDemetra+ has been [officially recommended](https://ec.europa.eu/eurostat/cros/system/files/Jdemetra_%20release.pdf), since 2 February 2015, to the members of the ESS and the European System of Central Banks as software for seasonal and calendar adjustment of official statistics.

Besides seasonal adjustment, JDemetra+ bundles other time series models that are useful in the production or analysis of economic statistics, including for instance outlier detection, nowcasting, temporal disaggregation or benchmarking. More details on the methodology used in JDemetra+ can be found in the JDemetra+ manuals and user guides [@grudkowska2015jdemetrarm; @grudkowska2015jdemetraug].

The package \pkg{RJDemetra} provides a R interface to the seasonal adjustment software JDemetra+. \pkg{RJDemetra} uses Java libraries of JDemetra+, thus it relies on the \pkg{rJava} [@rJava] package and Java SE 8 or later version is required. It allows to:

* perform seasonal adjustment with TRAMO-SEATS+ and X-12ARIMA/X-13ARIMA-SEATS with pre-defined (section \ref{pre-def-est}) and user-defined specification (section \ref{user-def-spec});  
* acces to all the output available in JDemetra+ (section \ref{sa-obj-struc});  
* import and export JDemetra+ workspaces (section \ref{manipulate-workspace}).

It can be installed from CRAN:

```{r, eval= FALSE}
install.packages("RJDemetra")
```

The development version can be installed from GitHub with \pkg{devtools} [@devtools]:
```{r, eval= FALSE}
devtools::install_github("jdemetra/rjdemetra")
```

## Dataset

In this package the sts_inpr_m database of Eurostat is included, which contains monthly industrial production indices in manufacturing in the European Union. It contains 37 time series from january 1990 to december 2017 which are considered to be affected by seasonal and trading days effects. The data is a \code{ts} object and can be accessed using the \code{ipi_c_eu} object. The following snippet of code plots the industrial production index of the euro aera (EA19):

```{r basic_raw_data_plot}
library(RJDemetra)
plot(ipi_c_eu[, "EA19"])
```

## Print styling

By default, a color styling is used for the \code{print} methods of the objects created by \pkg{RJDemetra}. It can causes troubles with some outputs (for example with \pkg{rmarkdown} [@rmarkdown]) and can be disabled in each \code{print} function with the argument \code{enable_print_style = FALSE} or setting the global option \code{enable_print_style} to \code{FALSE}:

```{r}
options(enable_print_style = FALSE)
```


# Estimate a pre-defined RegARIMA and SA model {#pre-def-est}

As in JDemetra+, \pkg{RJDemetra} allows to perform seasonal adjustment using pre-defined model specifications. The pre-defined specifications correspond to most commonly used specifications and users are recommended to start their analysis with one of them. They are separately defined for TRAMO-SEATS and X-13ARIMA-SEATS estimation methods. It is also possible to perform only the  first step of seasonal adjustment (the RegARIMA estimation). The pre-defined model specifications are described in tables \ref{tab:pre_def_ts} and \ref{tab:pre_def_x13}. They are identical for pre-adjustment (column 1) and for seasonal adjustment (column 2). With more details, setting described in tables tables \ref{tab:pre_def_ts} and \ref{tab:pre_def_x13} are:

* Transformation test: a test to choose between an additive decomposition (no transformation) and a multiplicative decomposition (logarithmic transformation).  
* Pre-adjustment for leap-year: in the case of a multiplicaive decomposition; a correction of the February values is applied to the original series (before transformation). The original values in February are multiplied by $\frac{28.25}{29}$ for leap years, by $\frac{28.25}{28}$  for non-leap years and values for other months are not modified. In the case of multiplicative models, this is equivalent to adding a leap year regressor [@bell1992lengthmonthadj].
* Working days: a pre-test is made for a presence of a working day effect.  
* Trading days: a pre-test is made for a presence of a trading day effect.   
* Easter: a pre-test for a presence of  the Easter effect. The default length of the Easter effect is 6 days (for TRAMO-SEATS specifications) and 8 days (for X-13ARIMA-SEATS specifications).   
* Outliers: an automatic identification of three types of outliers: AO (additive outlier), LS (level shift) and TC (transitory change), using a default critical value. The automatic identification of SO (seasonal outlier) is not enabled by default.
* ARIMA model: the choice between fixing the ARIMA model structure to (0,1,1)(0,1,1) (Airline model) or searching for the ARIMA model using an automatic model identification procedure. The Airline model is used as a default model in several TRAMO-SEATS+ and X-13ARIMA-SEATS specifications because it has been shown in many studies that this model is appropriate for many real seasonal monthly or a quarterly time series. Moreover, the Airline model approximates well many other models and provides an excellent "benchmark" model [@maravall2009identification].


```{r pre_def_ts, echo=FALSE, results='asis'}
pre_def_spec_ts <- structure(list(TRAMO = c("TR0", "TR1", "TR2", "TR3", "TR4", "TR5", 
"TRfull (default)"), `TRAMO-SEATS` = c("RSA0", "RSA1", "RSA2", "RSA3", 
"RSA4", "RSA5", "RSAfull (default)"), `Trans-formation` = c("no", "test", 
"test", "test", "test", "test", "test"), `Pre-adjust-ment for leap-year` = c("no", 
"no", "no", "no", "no", "no", "yes"), `Working days` = c("no", 
"no", "test", "no", "test", "no", "no"), `Trading days` = c("no", 
"no", "no", "no", "no", "yes", "test"), `Easter effect` = c("no", 
"no", "test", "no", "test", "test (Standard)", "test (Include Easter)"
), Outliers = c("no", "test", "test", "test", "test", "test", 
"test"), `ARIMA model` = c("(0,1,1)(0,1,1)", "(0,1,1)(0,1,1)", 
"(0,1,1)(0,1,1)", "AMI", "AMI", "AMI", "AMI")), class = "data.frame", row.names = c(NA, 
-7L))
pre_def_spec_x13 <- structure(list(RegARIMA = c("RG0", "RG1", "RG2c", "RG3", "RG4c", 
"RG5c (default)"), `X-13ARIMA-SEATS` = c("", "RSA1", "RSA2c", "RSA3", 
"RSA4c", "RSA5 (default)"), `Trans-formation` = c("no", "test", "test", 
"test", "test", "test"), `Pre-adjust-ment for leap-year` = c("no", 
"no", "test", "no", "test", "test"), `Working days` = c("no", 
"no", "test", "no", "test", "no"), `Trading days` = c("no", "no", 
"no", "no", "no", "test"), `Easter effect` = c("no", "no", "test", 
"no", "test", "test"), Outliers = c("no", "test", "test", "test", 
"test", "test"), `ARIMA model` = c("(0,1,1)(0,1,1)", "(0,1,1)(0,1,1)", 
"(0,1,1)(0,1,1)", "AMI", "AMI", "AMI")), class = "data.frame", row.names = c(NA, 
-6L))

kable(pre_def_spec_ts, "latex", booktabs = T, caption = "Pre-defined specification for TRAMO and TRAMO-SEATS",align = "c") %>%
  column_spec(c(2,3,5), width = "1.cm") %>%
  column_spec(c(5,6,8), width = "0.9cm") %>% 
  column_spec(c(4,7), width = "1.5cm") %>% 
  kable_styling(font_size = 7) %>% 
  add_header_above(c("Specification"=2, ""))
```

```{r pre_def_x13, echo=FALSE, results='asis'}
kable(pre_def_spec_x13, "latex", booktabs = T, caption = "Pre-defined specification for RegARIMA and X-13ARIMA-SEATS", align = "c") %>%
  column_spec(c(3,5), width = "1.cm") %>%
  column_spec(c(5,6,7,8), width = "0.9cm")%>% 
  column_spec(c(2), width = "1.7cm") %>% 
  column_spec(c(4), width = "1.4cm") %>% 
  kable_styling(font_size = 7) %>% 
  add_header_above(c("Specification"=2, ""))
```


Four functions can be used in \pkg{RJDemetra} to perform an estimation with the pre-defined specification:

* RegARIMA
  + X-13ARIMA method: \code{regarima_def_x13()} 
  + TRAMO-SEATS method: \code{regarima_def_tramoseats()} 
* Seasonal adjustment
  + X-13ARIMA method: \code{x13_def()} 
  + TRAMO-SEATS method: \code{tramoseats_def()}

For examples:

```{r}
myseries <- ipi_c_eu[, "EA19"]

regx13 <- regarima_def_x13(myseries, spec = "RG5c")
regts <- regarima_def_tramoseats(myseries, spec = "TRfull")
sax13 <- x13_def(myseries, spec = "RSA3", userdefined = NULL)
sats <- tramoseats_def(myseries, spec = "RSAfull", userdefined = NULL)
```

In section \ref{user-def-spec} it is presented how to modify model specifications, including the possibility to incorprate user-defined regressors.

# Class object structure {#sa-obj-struc}

In section \ref{pre-def-est} it was presented how to run a RegARIMA and complete seasonal adjustment estimation with pre-defined model specifications. In this section the outcome will be described in detail. 

As a result of seasonal adjustment estimation (e.g. function \code {x13_def} or \code {tramoseats_def}) a S3 class object (\code{sa_object}) is created. It has a class \code{c("SA","X13")} or \code{c("SA","TRAMO_SEATS")} depending on the used estimation method. The \code{sa_object} consist of lists of S3 class sub-objects. For each of the class \code{print} and \code{plot} methods are defined. The complete structure of the \code{sa_object} is presented in table \ref{tab:obj_tab}. In general, the \code{sa_object} contains the following five objects: **regarima**, **decomposition**, **final**, **diagnostics** and **user_defined**. Independently which of the two estimation methods is used the regarima, final and diagnostics objects contain the same components, though with different classes (see table \ref{tab:obj_tab}). Whereas, the object decomposition differs for the two methods. The object user_defined is empty unless additional output was requested by the user (see sub-section \ref{user-def}). Finally, when estimating RegARIMA only the regarima object is created. All the plots methods are detailed in table \ref{tab:plots_methods}.

```{r obj_tab, echo=FALSE, results='asis'}
object=c("sa_object","regarima","specification","estimate","transform","regression","userdef","specification","outliers","variables","series","description","trading.days","easter","outliers","arima","specification","coefficients","forecast","span","arma","arima.coefficients","regression.coefficients","loglik","model","spec_rslt","effects","residuals","residuals.stat","st.error","tests","forecast","decomposition","specification","mode","mstats","si_ratio","s_filter","t_filter","decomposition","specification","mode","model","model","sa","trend","seasonal","transitory","irregular","linearized","components","final","series","forecasts","diagnostics","variance_decomposition","combined_test","tests_for_stable_seasonality","combined_seasonality_test","residuals_test","user_defined")
type=c("list","list","list","data.frame","data.frame","list","list","data.frame","data.frame or NA(empty)","list","mts, ts, matrix or NA(empty)","data.frame or NA(empty)","data.frame","data.frame","data.frame","list","data.frame","data.frame or NA(empty)","data.frame","data.frame","vector - numeric","matrix","matrix","matrix","list","data.frame","mts, ts, matrix","ts","list","numeric","data.frame","mts, ts, matrix","list","data.frame","character","matrix","mts, ts, matrix","vector - character","character","list","data.frame","character","list","matrix or empty list","matrix or empty list","matrix or empty list","matrix or empty list","matrix or empty list","matrix or empty list","mts, ts, matrix","mts, ts, matrix","list","mts, ts, matrix","mts, ts, matrix","list","data.frame","list","data.frame","character","data.frame","list")
class1=c("SA, X13","regarima, X13","","","","","","","","","","","","","","","","","","","","","","","","","","","","","regarima_rtests, data.frame","","decomposition_X11","X11_spec, data.frame","","","","","","","seats_spec, data.frame","","","","","","","","","","","final","","","diagnostics","","combined_test","","","","user_defined")
class2=c("SA, TRAMO_SEATS","regarima, TRAMO_SEATS","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","decomposition_SEATS","","","","","","","","","","","","","","","","","","","","","")
level=c(0,1,2,3,3,3,4,5,5,5,6,6,4,4,3,3,4,4,3,3,2,2,2,2,2,3,3,2,2,3,3,2,1,2,2,2,2,2,2,1,2,2,2,3,3,3,3,3,3,2,2,1,2,2,1,2,2,3,3,2,1)

obj_tab <-data.frame(cbind(object,level,type,class1,class2),stringsAsFactors = FALSE)

obj_tab[obj_tab[,"level"]==1,1] <- paste0("\\hspace{1em}",obj_tab[obj_tab[,"level"]==1,1])
obj_tab[obj_tab[,"level"]==2,1] <- paste0("\\hspace{2em}",obj_tab[obj_tab[,"level"]==2,1])
obj_tab[obj_tab[,"level"]==3,1] <- paste0("\\hspace{3em}",obj_tab[obj_tab[,"level"]==3,1])
obj_tab[obj_tab[,"level"]==4,1] <- paste0("\\hspace{4em}",obj_tab[obj_tab[,"level"]==4,1])
obj_tab[obj_tab[,"level"]==5,1] <- paste0("\\hspace{5em}",obj_tab[obj_tab[,"level"]==5,1])
obj_tab[obj_tab[,"level"]==6,1] <- paste0("\\hspace{6em}",obj_tab[obj_tab[,"level"]==6,1])

obj_tab <- apply(obj_tab, 2, function(x)gsub("_","\\_",x,fixed = TRUE))
colnames(obj_tab)=c("Object","Level","Type","Class","Class")

kable(obj_tab, "latex", longtable = T,escape = FALSE, booktabs = T, caption = "SA object structure")%>%
  
  add_header_above(c(" "," "," ","x13/x13_def"," tramoseats/tramoseats_def"), italic = T)%>%
  
  add_header_above(c(" "," "," ","When adjusted with:" = 2))%>%
  
  row_spec(c(2,33,40,52,55,61), bold = T)%>% 
  
  kable_styling(font_size = 7)
  
```

```{r plots_methods, echo=FALSE, results='asis'}
plot_methods <- structure(list(`Object class (\\code{x} object)` = c("\\code{regarima}", 
                                                            "\\code{regarima}", "\\code{regarima}", " \\code{regarima}", 
                                                            "\\code{regarima}", "\\code{regarima}", " \\code{regarima}", 
                                                            "\\code{decomposition_X11}, \\code{decomposition_SEATS}", " \\code{final}", 
                                                            "\\code{final} or \\code{SA}"), Method = c("\\code{plot(x, which = 1)}", "\\code{plot(x, which = 2)}", 
                                                                                          "\\code{plot(x, which = 3)}", "\\code{plot(x, which = 4)}", "\\code{plot(x, which = 5)}", 
                                                                                          "\\code{plot(x, which = 6)}", "\\code{plot(x, which = 7)}", "\\code{plot(x)}", 
                                                                                          "\\code{plot(x, type_chart = sa-trend)}", "\\code{plot(x, type_chart = cal-seas-irr)}"
                                                            ), Description = c("Plot of residuals", "Histogram of standardized residuals and density", 
                                                                               "Normal quantile-quantile (Q-Q) plot of standardized residuals", 
                                                                               "Autocorrelation function (ACF) of residuals", "Partial autocorrelation function (PACF) of residuals", 
                                                                               "Raw and linearized series", "Plots 3 graphics: linearised series, calendar effects and outliers effects", 
                                                                               "S-I ratio: seasonal-irregular (S-I) component and the seasonal factors for each period of the time series (months or quarters)", 
                                                                               "Plots the raw series, the seasonal adjusted series and the trend", 
                                                                               "Plots the calendar effects, the seasonal component and the irregular"
                                                            )), class = "data.frame", row.names = c(NA, -10L))


kable(plot_methods, "latex", longtable = T,
      escape = FALSE, booktabs = T,
      caption = "Plots available with the \\pkg{RJDemetra} package.") %>%
  column_spec(1, width = "4cm") %>%
  column_spec(2, width = "4.5cm") %>%
  column_spec(3, width = "6cm")
```

## Regarima

The regarima object contains the provided model specification (\code{specification}; level 2 of the \code{sa_object}), the estimated coefficients for the arima processes (\code{arima.coefficients}) and regressors (\code{regression.coefficients}), including arma orders (\code{arma}). It includes also model quality measures (\code{loglik}), regarima specification after its estimation with the estimated effects (e.g. linearized input series or outliers)(\code{model}), the residuals of the regarima model (\code{residuals}), several tests’ results for the residuals (\code{residuals.stat}) and finally the forecast of the pre-adjusted series (\code{forecasts}). All this information can be extracted individually by the user or a predefined output can be used by calling \code{print()} or \code{summary()} (for more detailed output) functions. Also a set of graphs is defined within the function \code{plot()}. For regarima by default the first six graphs are displayed, but specific ones can be chosen within the argument \code{which}. Table \ref{tab:plots_methods} summarizes all the graphs available for the \code{sa_object}, as well as its \code{plot()} options.

```{r}
sax13$regarima
summary(sax13$regarima)
plot(sax13$regarima, which = 2)
```

## Decomposition

As afore-mentioned the decomposition method differs between TRAMO-SEATS+ and X-12ARIMA/X-13ARIMA, where SEATS is based on ARIMA-model and X11-algorithm on linear filters. Therefore also the composition of this object differs when estimating with the two methods (hence the two decomposition objects in the table \ref{tab:obj_tab}). The only common part is the first two sub-objects with the model specification (\code{specification}) and information on the decomposition mode (\code{mode}; e.g.: additive).

Then, the \code{decomposition_X11} object comprises quality measures on the decomposition (\code{mstats}), namely the $M$ and $Q$ statistics. It contains also the final unmodified S-I ratios $d8$ and final seasonal factors $d10$ (\code{si_ratio}), as well as the information on the final seasonal filter (\code{s_filter}) and trend filter(\code{t_filter}). The code below presents the output for X11 decomposition:
```{r}
sax13$decomposition
```

As a reminder, in SEATS it is assumed that each component of the linearized series (received from TRAMO) is an outcome of a linear stochastic process and SEATS estimates an ARIMA model for each component (i.e. trend, seasonal, transitory and irregular). Subsequently, the \code{decomposition_SEATS} object contains the information on the estimated ARIMA models (\code{model}), the linearized components, as obtained from TRAMO (\code{linearized}), and the theoretical components calculated from the ARIMA models (\code{components}). The code below presents the output for the SEATS decomposition, with the information on the ARIMA models:

```{r}
sats$decomposition
```

## Final
The final object has a simple structure as it includes the input series, final seasonally adjusted series and the final components (i.e. $t$ - trend-cycle, $s$ - seasonal component and $i$ - irregular component) (\code{series}), as well as their forecasts (\code{forecasts}). 
```{r}
sats$final
```

## Diagnostics
This part of the \code{sa_object} includes several diagnostics on the presence of seasonality in the input series and on the quality of the seasonal adjustment.

The test for the seasonality presence (\code{combined_test}) are performed both on the entire series and in the last 3 years.

Whereas, the quality checking is grouped into two sets. The first looks at the contribution of each estimated component to the variance of the original series (\code{variance_decomposition}). The second verifies, with different tests, that there is no seasonal pattern left in the seasonally adjusted series and in the irregular component (\code{residuals_test}).

All the checks (except \code{combined_seasonality_test}), together with a detailed description, are displayed when printing the diagnostics object.

```{r}
sats$diagnostics
```

## user defined {#user-def}

As presented in the table \ref{tab:obj_tab} and in the previous sections the \code{sa_object} has a defined structure with a defined content. Nevertheless the user can extract additional output from the seasonal adjustment estimation that will be stored under user_defined object in a form of a list.  In order extract the additional output the extra variables need to be defined as characters under the argument \code{userdefined} of the functions \code{x13_def()}, \code{tramoseats_def()}, \code{x13()} or \code{tramoseats()} (the latter two functions are presented in the next section \ref{user-def-spec}).

For example, to extract the additional tables $c10$ and $d16$  the following need to be specified in the function argument:

```{r}
sa_usrdef <- x13_def(myseries, spec = "RSA3", 
                     userdefined = c("decomposition.c10", "decomposition.d16"))
sa_usrdef$user_defined
```

The list of all available variables can be extracted with the following functions:

*  \code{user_defined_variables("X13-ARIMA")}
*  \code{user_defined_variables("TRAMO-SEATS")}


# Model specification: creation and modification {#user-def-spec}

The user can also create it's own specification, modifying a pre-defined specification (described in tables \ref{tab:pre_def_ts} and \ref{tab:pre_def_x13}) or a previously defined specification. For that, they are two functions for each method (RegARIMA model or seasonal adjustment with X-13ARIMA or TRAMO-SEATS):

1. One to create a specification from a pre-defined JDemetra+ model specification. The corresponding functions are: \code{regarima_spec_def_x13()} and \code{regarima_def_tramoseats()} for the RegARIMA model and \code{x13_spec_def()} and \code{tramoseats_spec_def()} for the entire seasonal adjustment model (including the pre_adjustment with a RegARIMA model).

2. One to create a specification from a previous specification or a model. The corresponding functions are: \code{regarima_spec_x13()} and \code{regarima_tramoseats()} for the RegARIMA model and \code{x13_spec()} and \code{tramoseats_spec()} for the entire seasonal adjustment model (including the pre_adjustment with a RegARIMA model).

Once the specification it's created, the regARIMA model can be performed by \code{regarima()}, the seasonal adjustment with X-13ARIMA by \code{x13()} and with TRAMO-SEATS by \code{tramoseats()}

For example, to create it's own RegARIMA model for the TRAMO-SEATS method adding an additive outlier in October 2009:

```{r}
regarima_ts_spec <- regarima_spec_def_tramoseats(spec = "TRfull",
             usrdef.outliersEnabled = TRUE,
             usrdef.outliersType = "AO",
             usrdef.outliersDate = "2009-10-01")
regarima_ts_model <- regarima(series = ipi_c_eu[, "EA19"],
                              spec = regarima_ts_spec)
regarima_ts_model
```

And to modify the specification of the x-13ARIMA model of the object \code{sa_usrdef}, defined in section \ref{user-def}, changing the seasonal filter and performing a working day adjustment:
```{r}
sa_x13_spec <- x13_spec(object = sa_usrdef,
                         tradingdays.option = "WorkingDays",
                         x11.seasonalma = "S3X3")
sa_x13_model <- x13(series = ipi_c_eu[, "EA19"],
                    spec = sa_x13_spec)
```

Almost all the specification available in JDemetra+ can be used in \pkg{RJDemetra}[^3]. For more details see the help of the correponding function or the documentation of JDemetra+.

[^3]: In the current release of the package, it is not possible to use user-defined calendars regressors: they have to be added as user-defined variable (the difference is that there is no automatic test to remove or not the regressors). Moreover, contrary to what is possible under JDemetra+, ramp effects and intervention variables are not intended to be added in the specification since the corresponding regressors can be easily created through \proglang{R}.

To prevent from wrong user-defined specification, they are also automatic checks in \pkg{RJDemetra}, like in JDemetra+. For example, to pre-specify an outlier or a user-defined variable you have to enable them (setting the parameter \code{usrdef.outliersEnabled} or \code{usrdef.varEnabled} to \code{TRUE}); or to fix the coefficient of an outlier or a user-defined regresso you have specify the transformation function (\code{transform.function}, it cannot be automatic). Those checks are done each time a new specification it's create. Therefore, some specifications cannot be setted in two staged. For example, fixing the coefficient of an outlier has to be done the save time the outliers are defined. The following code doesn't fix the coefficient of the outlier previously in January 2001:

```{r}
regarima_wrong_spec <- regarima_spec_tramoseats(object = regarima_ts_model,
             transform.function = "Log",
             usrdef.outliersCoef =  -0.8)
```

To fix it you have to re-defined the outlier:
  
```{r}
regarima_good_spec <- regarima_spec_tramoseats(object = regarima_ts_model,
             transform.function = "Log",
             usrdef.outliersType = "AO",
             usrdef.outliersDate = "2009-10-01",
             usrdef.outliersCoef =  -0.8)
```

# Manipulate JDemetra+ workspaces {#manipulate-workspace}

\pkg{RJDemetra} allows to interact with JDemetra+ workspace that can be openned by the software. A workspace includes:

- The XML file that enables the user to import the workspace to JDemetra+ and to display it content;  
- A folder containing several sub-folfders that correspond to the different types of items created by the user.

Each workspace can contain several multi-processings and each multi-processing stores the results of the seasonal adjustment procedure performed with the TRAMO-SEATS or X-13ARIMA-SEATS methods.

Export models to workspace allows to store easily the seasonal adjustment models, to change the specifications with the JDemetra+ graphical interface and to give models users unfamiliar with \proglang{R}.

## Export a workspace {#export-wk}

Four functions have to be used to export models:

- \code{new_workspace()} to create a workspace;  
- \code{new_multiprocessing()} to create a multi-processing in a workspace;  
- \code{add_sa_item()} to add a seasonal adjustment model to a multi-processing;  
- \code{save_workspace()} to export the workspace.  

The following command export the seasonal adjustment models compute by TRAMO-SEATS+ and X-13ARIMA-SEATS:

```{r}
myseries <- ipi_c_eu[, "EA19"]
sa_x13 <- x13_def(myseries)
sa_ts <- tramoseats_def(myseries)
```

To create a workspace and a multi-processing names "MP-1":
```{r}
wk <- new_workspace()
new_multiprocessing(wk, name = "MP-1")
```

The two models will be added in the multiprocessing "MP1": the name of the seasonal adjustment model computed with X-13ARIMA-SEATS will be "SA with X13" and the one with TRAMO-SEATS+ will be "SA with TramoSeats":

```{r}
add_sa_item(wk, multiprocessing = "MP-1",
            sa_obj = sa_x13, name =  "SA with X13")
add_sa_item(wk, multiprocessing =  "MP-1",
            sa_obj = sa_ts, name = "SA with TramoSeats")
```

The workspace exported is named "workspace.xml":
```{r}
save_workspace(wk, file =  "workspace.xml")
```


## Import a workspace

Height functions can be used to import a workspace: 

- \code{load_workspace()} to load a workspace;  
- \code{compute()} to compute the multi-processings: by default a workspace only contains definitions, computation is needed to get the seasonal adjustment model;  
- \code{get_model()} to get the seasonal adjusted models;  
- \code{get_ts()} to get the input raw time series,  \code{get_object()} and \code{get_all_objects} to navigate inside the workspace (extract a multi-processing or a seasonal adjustment model), \code{get_name()} to get the names of the multiprocessings or the seasonal adjustment models and \code{count()} to count the number of multiprocessing or seasonal adjustment models.

For instance, to import the workspace created in section \ref{export-wk} and to get the first multiprocessing and the first seasonal adjustment model:

```{r}
wk <- load_workspace(file =  "workspace.xml")
mp1 <- get_object(wk, 1)
sa_item1 <- get_object(mp1, 1)
```

To get the number of seasonal adjustment models in the multiprocessing:
```{r}
count(mp1)
```

And the name of the first seasonal adjustment model in JDemetra+:
```{r}
get_name(sa_item1) 
```

Raw time series and seasonal adjustment model can now be imported:
```{r}
raw_ts <- get_ts(sa_item1)
compute(wk)
sa_model1 <- get_model(sa_item1, workspace = wk)
```

\code{get_ts()} and \code{get_model()} can also be used directly to the workspace or a multiprocessing to import all the raw time series or all the seasonal adjustment model:

- for a multiprocessing the result is a list which each element contains the information of a seasonal adjustment model;  
- for a workspace the result is a list of length the number of multi-processing and which each element contains a list with the information of each seasonal adjustment model.

For example to get all raw time series of the workspace and all seasonal adjustmen models of the first multi-processing:

```{r, eval=FALSE}
all_raw_ts <- get_ts(wk)
sa_models_of_mp1 <- get_model(mp1, workspace = wk)
```

The imports of seasonal adjustment models from a workspace works well when it has been created throw \pkg{RJDemetra}. They may be some troubles when importing a workspace created with JDemetra+, in particular:

- \pkg{RJDemetra} doesn't support yet user-defined calendars. A seasonal adjustment model defined with a specific calendar or user-defined calendar regressors will be partially imported. The result will be correct but changing the specification (throw \code{x13_spec()} or \code{tramoseats_spec()}) will erase user-defined calendars.  
- Seasonal adjustment models with ramp effect or intervention variables will be partially imported: the result of the imported model will be correct but changing the specification (throw \code{x13_spec()} or \code{tramoseats_spec()}) will erase them.  
- Seasonal adjustment models with no pre-processing (X-11 specification) are not supported: \code{NULL} object will be returned.


# Conclusion

# Acknowledgments {-}


# References


