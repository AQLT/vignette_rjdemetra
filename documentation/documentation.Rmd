---
author:
  - name: Anna Michalek
    affiliation: European Central Bank
    email: \email{anna.michalek@ecb.int}
  - name: Alain Quartier-La-Tente
    affiliation: Insee
    email: \email{alain.quartier@gmail.com}
title:
  formatted: "\\pkg{RJDemetra}: A R Interface To JDemetra+ Seasonal Adjustment Software"
  # If you use tex in the formatted title, also supply version without
  plain:     "A Capitalized Title: Something about a Package foo"
  # For running headers, if needed
  short:     "\\pkg{RJDemetra}: A Capitalized Title"
abstract: >
  The abstract of the article.
keywords:
  # at least one keyword must be supplied
  formatted: ["\\proglang{R}", seasonal adjustment, time series]
  plain:     [R, seasonal adjustment, time series]
preamble: >
  \usepackage{amsmath}
  \usepackage{booktabs}
  \usepackage{longtable}
  \usepackage{array}
  \usepackage{multirow}
  \usepackage{wrapfig}
  \usepackage{float}
  \usepackage{pdflscape}
  \usepackage{tabu}
  \usepackage{threeparttable}
  \usepackage{threeparttablex}
  \usepackage[normalem]{ulem}
  \usepackage{makecell}

output: rticles::jss_article
---
```{r, include=FALSE}
library(knitr)
library(kableExtra)
library(RJDemetra)
options(enable_print_style = FALSE)
# A travailler
# caption_below <- function(table){
#   lines <- strsplit(table,"\\n")[[1]]
#   caption_line <- grep("\\caption{",lines,fixed = TRUE)
#   if(length(caption_line) >0){
#     caption_line_text <- lines[caption_line]
#     caption_line_text <- sub("\\\\\\\\$","", caption_line_text)
#     lines <- gsub("\\end{longtable}",sprintf("%s\\end{longtable}", caption_line_text),lines,fixed = TRUE)
#   }
#   lines <- paste0(lines,collapse = "\\n")
#   lines
# }
```

# Introduction

The package \pkg{RJDemetra} provides a R interface to the seasonal adjustment software JDemetra+. Note that, JDemetra+ being implemented in Java, \pkg{RJDemetra} relies on the \pkg{rJava} package and Java SE 8 or later version is required. The two leading seasonal adjustment methods TRAMO/SEATS+ and X-12ARIMA/X-13ARIMA-SEATS can be used with all the specifications defined in JDemetra+.

## Seasonal adjustment in brief 

Mention the two SA methods and the two steps of adjustment: pre-adjustment and the decomposition. Briefly present the differences in the decomposition. 


# RJDemetra basics

The \pkg{RJDemetra} package alows to:
 
* create and modify model specifications
* create and modify models
* import/export JDemetra+ workspaces

## Dataset

In this package we include the sts_inpr_m database of Eurostat, which contains the monthly industrial production indices in manufacturing in the European Union. It contains 37 time series from january 1990 to december 2017 which are considered to be affect by seasonal and working day effects. The data is a \code{ts} object and can be accessed using the \code{ipi_c_eu} object. The following snippet of code plot the industrial production index of the Euro aera:

```{r}
library(RJDemetra)
plot(ipi_c_eu[, "EA19"])
```

# Estimate a predefined regarima and SA model
The package allows to estimate regarima and SA models using predefined specifications. 

```{r}
library(RJDemetra)
myseries <- ipi_c_eu[, "FR"]
mysa <- x13_def(myseries, spec=c("RSA5c"))
```


# SA object structure

```{r echo=FALSE, results='asis'}
object=c("sa_object","regarima","specification","estimate","transform","regression","userdef","specification","outliers","variables","series","description","trading.days","easter","outliers","arima","specification","coefficients","forecast","span","arma","arima.coefficients","regression.coefficients","loglik","model","spec_rslt","effects","residuals","residuals.stat","st.error","tests","forecast","decomposition","specification","mode","mstats","si_ratio","s_filter","t_filter","decomposition","specification","mode","model","model","sa","trend","seasonal","transitory","irregular","linearized","components","final","series","forecasts","diagnostics","variance_decomposition","combined_test","tests_for_stable_seasonality","combined_seasonality_test","residuals_test","user_defined")
type=c("list","list","list","data.frame","data.frame","list","list","data.frame","data.frame or NA(empty)","list","mts, ts, matrix or NA(empty)","data.frame or NA(empty)","data.frame","data.frame","data.frame","list","data.frame","data.frame or NA(empty)","data.frame","data.frame","vector - numeric","matrix","matrix","matrix","list","data.frame","mts, ts, matrix","ts","list","numeric","data.frame","mts, ts, matrix","list","data.frame","character","matrix","mts, ts, matrix","vector - character","character","list","data.frame","character","list","matrix or empty list","matrix or empty list","matrix or empty list","matrix or empty list","matrix or empty list","matrix or empty list","mts, ts, matrix","mts, ts, matrix","list","mts, ts, matrix","mts, ts, matrix","list","data.frame","list","data.frame","character","data.frame","list")
class1=c("SA, X13","regarima, X13","","","","","","","","","","","","","","","","","","","","","","","","","","","","","regarima_rtests, data.frame","","decomposition_X11","X11_spec, data.frame","","","","","","","seats_spec, data.frame","","","","","","","","","","","final","","","diagnostics","","combined_test","","","","user_defined")
class2=c("SA, TRAMO_SEATS","regarima, TRAMO_SEATS","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","decomposition_SEATS","","","","","","","","","","","","","","","","","","","","","")
level=c(0,1,2,3,3,3,4,5,5,5,6,6,4,4,3,3,4,4,3,3,2,2,2,2,2,3,3,2,2,3,3,2,1,2,2,2,2,2,2,1,2,2,2,3,3,3,3,3,3,2,2,1,2,2,1,2,2,3,3,2,1)

obj_tab <-data.frame(cbind(object,level,type,class1,class2),stringsAsFactors = FALSE)

obj_tab[obj_tab[,"level"]==1,1] <- paste0("\\hspace{1em}",obj_tab[obj_tab[,"level"]==1,1])
obj_tab[obj_tab[,"level"]==2,1] <- paste0("\\hspace{2em}",obj_tab[obj_tab[,"level"]==2,1])
obj_tab[obj_tab[,"level"]==3,1] <- paste0("\\hspace{3em}",obj_tab[obj_tab[,"level"]==3,1])
obj_tab[obj_tab[,"level"]==4,1] <- paste0("\\hspace{4em}",obj_tab[obj_tab[,"level"]==4,1])
obj_tab[obj_tab[,"level"]==5,1] <- paste0("\\hspace{5em}",obj_tab[obj_tab[,"level"]==5,1])
obj_tab[obj_tab[,"level"]==6,1] <- paste0("\\hspace{6em}",obj_tab[obj_tab[,"level"]==6,1])

obj_tab <- apply(obj_tab, 2, function(x)gsub("_","\\_",x,fixed = TRUE))
colnames(obj_tab)=c("Object","Level","Type","Class","Class")

kable(obj_tab, "latex", longtable = T,escape = FALSE, booktabs = T, caption = "SA object structure")%>%
  
  add_header_above(c(" "," "," ","x13/x13_def"," tramoseats/tramoseats_def"), italic = T)%>%
  
  add_header_above(c(" "," "," ","When adjusted with:" = 2))%>%
  
  row_spec(c(2,33,40,52,55,61), bold = T)%>% 
  
  kable_styling(font_size = 7)
  
```

## Regarima

Here we can also present the output: print and graphs.
```{r}
library(RJDemetra)
myseries <- ipi_c_eu[, "FR"]
mysa <- x13_def(myseries, spec=c("RSA5c"))
mysa$regarima
```

## Decomposition

## Final

## Diagnostics

## user defined

# Model specification: creation and modification 

Like in JDemetra+, the \pkg{RJDemetra} package contains pre-defined specifications that can be used to: 

- pre-adjust a timeseries with TRAMO (\code{regarima_def_tramoseats()}) or RegARIMA (\code{regarima_def_x13()});  
- seasonally adjust a time series with TRAMO/SEATS  (\code{tramoseats_def()}) and X-13ARIMA-SEATS  (\code{x13_def()}).

They are described in tables \ref{tab:pre_def_ts} and \ref{tab:pre_def_x13}. They correspond to the most commonly used specifications and users are recommended to start their analysis with one of those specification. Pre-defined specifications are identical for pre-adjustment and for seasonal adjustment.

```{r, echo=FALSE, results='asis'}
pre_def_spec_ts <- structure(list(TRAMO = c("TR0", "TR1", "TR2", "TR3", "TR4", "TR5", 
"TRfull (default)"), `TRAMO-SEATS` = c("RSA0", "RSA1", "RSA2", "RSA3", 
"RSA4", "RSA5", "RSAfull (default)"), `Trans-formation` = c("no", "test", 
"test", "test", "test", "test", "test"), `Pre-adjust-ment for leap-year` = c("no", 
"no", "no", "no", "no", "no", "yes"), `Working days` = c("no", 
"no", "test", "no", "test", "no", "no"), `Trading days` = c("no", 
"no", "no", "no", "no", "yes", "test"), `Easter effect` = c("no", 
"no", "test", "no", "test", "test (Standard)", "test (Include Easter)"
), Outliers = c("no", "test", "test", "test", "test", "test", 
"test"), `ARIMA model` = c("(0,1,1)(0,1,1)", "(0,1,1)(0,1,1)", 
"(0,1,1)(0,1,1)", "AMI", "AMI", "AMI", "AMI")), class = "data.frame", row.names = c(NA, 
-7L))
pre_def_spec_x13 <- structure(list(RegARIMA = c("RG0", "RG1", "RG2c", "RG3", "RG4c", 
"RG5c (default)"), `X-13ARIMA-SEATS` = c("X11", "RSA1", "RSA2c", "RSA3", 
"RSA4c", "RSA5 (default)"), `Trans-formation` = c("no", "test", "test", 
"test", "test", "test"), `Pre-adjust-ment for leap-year` = c("no", 
"no", "test", "no", "test", "test"), `Working days` = c("no", 
"no", "test", "no", "test", "no"), `Trading days` = c("no", "no", 
"no", "no", "no", "test"), `Easter effect` = c("no", "no", "test", 
"no", "test", "test"), Outliers = c("no", "test", "test", "test", 
"test", "test"), `ARIMA model` = c("(0,1,1)(0,1,1)", "(0,1,1)(0,1,1)", 
"(0,1,1)(0,1,1)", "AMI", "AMI", "AMI")), class = "data.frame", row.names = c(NA, 
-6L))

kable(pre_def_spec_ts, "latex", booktabs = T, caption = "\\label{tab:pre_def_ts}Pre-defined specification for TRAMO and TRAMO-SEATS",align = "c") %>%
  column_spec(c(2,3,5), width = "1.cm") %>%
  column_spec(c(5,6,8), width = "0.9cm") %>% 
  column_spec(c(4,7), width = "1.5cm") %>% 
  kable_styling(font_size = 7) %>% 
  add_header_above(c("Specification"=2, ""))

kable(pre_def_spec_x13, "latex", booktabs = T, caption = "\\label{tab:pre_def_x13}Pre-defined specification for RegARIMA and X-13ARIMA-SEATS", align = "c") %>%
  column_spec(c(3,5), width = "1.cm") %>%
  column_spec(c(5,6,7,8), width = "0.9cm")%>% 
  column_spec(c(2), width = "1.7cm") %>% 
  column_spec(c(4), width = "1.4cm") %>% 
  kable_styling(font_size = 7) %>% 
  add_header_above(c("Specification"=2, ""))
```


The model specification can be defined from an existing model specification or an estimated model, as each of the estimated model contains also its specification. 

## X13

## TRAMOSEATS

## Regarima 

## Wrong specifications corrections
Parler des corrections automatiques ?
  
  
# Manipulate JDemetra+ workspaces
  Mise en garde sur ce que l'on ne peut pas faire (problèmes d'imports)

# Advanced usage and examples





